<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Legend of Tobias</title>
    <style>
      body {
        margin: 0;
        padding-top: 2rem;
      }

      canvas {
        display: block;
        margin: 0 auto;
      }
    </style>
  </head>
  <body>
    <script src="https://kaboomjs.com/lib/0.6.0/kaboom.js"></script>
    <script type="module">
      kaboom({
        global: true,
        scale: 2,
        debug: true,
        width: 500,
        height: 300,
        clearColor: [0, 0, 0, 1],
      });

      loadSound("ey1", "/assets/ey1.mp3");
      loadSound("ey2", "/assets/ey2.mp3");
      loadSound("ey3", "/assets/ey3.mp3");

      loadSprite("bg", "/assets/background.jpeg");
      loadSprite("balck", "/assets/balck.png");
      loadSprite("tobias", "/assets/tobias3.png", {
        sliceX: 3,
        sliceY: 2,
        anims: {
          idle: {
            from: 0,
            to: 1,
          },
          run: {
            from: 3,
            to: 5,
          },
          jump: {
            from: 2,
            to: 2,
          },
        },
      });

      loadSprite("tiles", "/assets/tiles.png", {
        sliceX: 14,
        sliceY: 7,
      });

      scene("game", () => {
        const PLAYER_SPEED = 200;
        const PLATFORM_WIDTH = 5;
        const PLATFORM_HEIGHT = 6;
        const PLATFORM_MARGIN = 120;
        const JUMP_FORCE = 600;
        const PLATFORM_FRAME = 0;
        const PROJECTILE_SPEED = 300;

        let platformSpeed = 100;
        let playerScore = 0;

        gravity(2000);

        layers(["game", "ui"], "game");

        add([
          sprite("bg", {
            width: width(),
            height: height(),
          }),
        ]);

        const scoreLabel = add([
          text(playerScore, 32),
          pos(12, 12),
          layer("ui"),
        ]);

        const hpLabel = add([
          text("HP", 20),
          pos(width() - 100 - 20 - 50, 15),
          layer("ui"),
        ]);

        const healthbar = add([
          rect(100, 20),
          pos(width() - 100 - 20, 15),
          color(1, 0, 0),
          layer("ui"),
        ]);

        const player = add([
          sprite("tobias", {
            animSpeed: 0.2,
          }),
          pos(width() / 2, height() / 2),
          origin("bot"),
          body(),
        ]);

        player.play("idle");

        player.action(() => {
          if (player.pos.x - player.width / 2 <= 0) {
            player.pos.x = 0 + player.width / 2;
          }

          // Keep player from going off screen to the right
          if (player.pos.x + player.width / 2 >= width()) {
            player.pos.x = width() - player.width / 2;
          }

          if (player.pos.y >= height() + 24) {
            go("gameover", playerScore);
          }
        });

        action("platform", (platform) => {
          platform.move(-platformSpeed, 0);

          if (platform.pos.x <= -PLATFORM_WIDTH / 2) {
            platform.destroy();
          }
        });

        function spawnPlatform(x, y, randWidth) {
          // Select a random platform frame for different looks
          //   const platformType = Math.floor(rand(0, 3));

          for (let i = 0; i < randWidth; i++) {
            add([
              sprite("tiles", {
                frame: PLATFORM_FRAME,
              }),
              pos(x + 12 * i, y),
              origin("center"),
              solid(),
              scale(0.2),
              "platform",
            ]);
          }
        }

        // loop(1, () => {
        //   playerScore += 1;
        //   scoreLabel.text = playerScore;
        //   platformSpeed += 10;
        // });

        // Spawn initial platform to land on
        spawnPlatform(0, height() - PLATFORM_HEIGHT, 100);

        loop(5, () => {
          // const y = rand(PLATFORM_MARGIN, height() - PLATFORM_HEIGHT);

          spawnPlatform(0, height() - PLATFORM_HEIGHT, 100);
          //   spawnPlatform(
          //     width() + PLATFORM_WIDTH / 2,
          //     height() / 2 + 40,
          //     randWidth
          //   );
        });

        keyPress("space", () => {
          if (!player.grounded()) {
            return;
          }
          player.jump(JUMP_FORCE);
          player.play("jump");

          const jumpSound = Math.round(rand(1, 3));
          play(`ey${jumpSound}`);
        });

        keyDown("left", () => {
          player.move(-PLAYER_SPEED, 0);
        });

        keyDown("right", () => {
          player.move(PLAYER_SPEED, 0);
        });

        // Animations
        player.on("grounded", () => {
          if (keyIsDown("left") || keyIsDown("right")) {
            player.play("run");
          } else {
            player.play("idle");
          }
        });

        keyPress("left", () => {
          if (player.grounded()) {
            player.play("run");
          }
        });

        keyPress("right", () => {
          if (player.grounded()) {
            player.play("run");
          }
        });

        keyPress("f", () => {
          add([
            sprite("balck"),
            pos(player.pos.x + player.width, player.pos.y - player.height / 2),
            origin("right"),
            scale(0.2),
            "projectile",
          ]);
        });

        action("projectile", (projectile) => {
          projectile.move(PROJECTILE_SPEED, 0);

          if (projectile.pos.x >= width() + projectile.width) {
            projectile.destroy();
          }
        });

        keyRelease(["left", "right"], () => {
          if (player.grounded()) {
            player.play("idle");
          }
        });
      });

      scene("gameover", (score) => {
        add([text("Game Over", 16), pos(width() / 2, 120), origin("center")]);

        add([text(score, 48), pos(width() / 2, 180), origin("center")]);

        keyPress("space", () => {
          go("game");
        });
      });

      go("game");
    </script>
  </body>
</html>
